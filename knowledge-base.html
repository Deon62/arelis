<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Base – The Foundry Africa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="ai-page">

  <div class="ai-app">
    <button type="button" class="ai-sidebar-toggle" id="ai-sidebar-toggle" aria-label="Open menu" aria-expanded="false">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <aside class="ai-sidebar">
      <div class="ai-sidebar-inner">
        <nav class="ai-panel-nav">
          <a href="ai.html">AI</a>
          <a href="dashboard.html">Dashboard</a>
          <a href="knowledge-base.html" class="ai-panel-nav-active">Knowledge Base</a>
          <a href="lawyer-sessions.html">Lawyer Sessions</a>
          <a href="billing.html">Billing</a>
        </nav>
      </div>
      <div class="ai-sidebar-account" id="sidebar-account">
        <button type="button" class="ai-account-btn" id="account-btn" aria-label="Account menu">
          <span class="ai-account-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
          <span class="ai-account-name">My account</span>
        </button>
        <div class="ai-account-menu" id="account-menu">
          <a href="index.html" class="ai-account-menu-item">Home</a>
          <a href="#" class="ai-account-menu-item ai-account-logout" data-action="logout">Log out</a>
        </div>
      </div>
    </aside>
    <div class="ai-sidebar-overlay" id="ai-sidebar-overlay" aria-hidden="true"></div>

    <main class="ai-main">
      <div class="kb">
        <div class="kb-header">
          <label class="kb-upload-btn" id="kb-upload-label">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <span class="kb-upload-text" id="kb-upload-text">Upload files</span>
            <input type="file" id="kb-file-input" class="kb-file-input" accept=".pdf" multiple>
          </label>
        </div>
        <p class="kb-status" id="kb-status" aria-live="polite"></p>

        <div class="kb-drop-zone" id="kb-drop-zone">
          <div class="kb-drop-inner">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" class="kb-drop-icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <p class="kb-drop-text">Drag & drop files here, or click upload above</p>
            <p class="kb-drop-hint">PDF</p>
          </div>
        </div>

        <div class="kb-files" id="kb-files-list"></div>
        <div class="kb-empty-card" id="kb-empty" style="display:none">No documents yet. Upload a PDF to build your Knowledge Base.</div>
      </div>
    </main>
  </div>

  <script src="auth-guard.js"></script>
  <script src="app-shell.js"></script>
  <script>
    (function() {
      var API = 'http://localhost:8001';
      var accountBtn = document.getElementById('account-btn');
      var accountMenu = document.getElementById('account-menu');
      if (accountBtn && accountMenu) {
        accountBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          accountMenu.classList.toggle('is-open');
        });
        document.addEventListener('click', function() {
          accountMenu.classList.remove('is-open');
        });
      }

      var fileInput = document.getElementById('kb-file-input');
      var filesList = document.getElementById('kb-files-list');
      var dropZone = document.getElementById('kb-drop-zone');
      var uploadLabel = document.getElementById('kb-upload-label');
      var uploadText = document.getElementById('kb-upload-text');
      var statusEl = document.getElementById('kb-status');
      var emptyEl = document.getElementById('kb-empty');
      var isUploading = false;
      var originalUploadText = uploadText ? uploadText.textContent : 'Upload files';
      var currentDocs = [];

      function safeParse(str, fallback) {
        try { return JSON.parse(str); } catch(e) { return fallback; }
      }

      function getUserId() {
        var u = safeParse(localStorage.getItem('fa_user') || '', null);
        return (u && (u.id || u.email)) ? String(u.id || u.email) : 'anon';
      }

      var DOCS_CACHE_KEY = 'fa_kb_docs_' + getUserId();

      function setStatus(msg) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.style.display = msg ? '' : 'none';
      }

      function setUploading(on) {
        isUploading = !!on;
        if (uploadLabel) uploadLabel.classList.toggle('is-uploading', on);
        if (uploadText) uploadText.textContent = on ? 'Uploading…' : originalUploadText;
        setStatus(on ? 'Uploading & indexing your PDF… this can take a moment.' : '');
      }

      function renderDocs(docs, opts) {
        if (!filesList) return;
        opts = opts || {};
        docs = Array.isArray(docs) ? docs : [];

        // Avoid flicker: if server briefly returns an empty list while we already
        // have docs on screen (e.g., during backend reload), keep current docs.
        if (!opts.force && docs.length === 0 && currentDocs && currentDocs.length) {
          if (emptyEl) emptyEl.style.display = 'none';
          return;
        }

        currentDocs = docs;
        try { localStorage.setItem(DOCS_CACHE_KEY, JSON.stringify(currentDocs)); } catch(e) {}

        filesList.innerHTML = '';
        (currentDocs || []).forEach(function(doc) {
          var item = document.createElement('div');
          item.className = 'kb-file-item';
          item.setAttribute('data-doc-id', doc.id);
          item.innerHTML =
            '<span class="kb-file-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>' +
            '<div class="kb-file-info">' +
              '<span class="kb-file-name">' + doc.filename + '</span>' +
              '<span class="kb-file-meta">PDF \u00b7 Uploaded</span>' +
            '</div>' +
            '<button type="button" class="kb-file-remove" aria-label="Remove file" title="Remove"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';
          filesList.appendChild(item);
        });

        if (emptyEl) emptyEl.style.display = currentDocs.length ? 'none' : '';
      }

      function renderPending(files) {
        if (!filesList) return;
        for (var i = 0; i < files.length; i++) {
          var f = files[i];
          var item = document.createElement('div');
          item.className = 'kb-file-item is-pending';
          item.innerHTML =
            '<span class="kb-file-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></span>' +
            '<div class="kb-file-info">' +
              '<span class="kb-file-name">' + f.name + '</span>' +
              '<span class="kb-file-meta">Uploading…</span>' +
            '</div>';
          filesList.prepend(item);
        }
      }

      async function fetchDocs() {
        setStatus(isUploading ? 'Uploading & indexing your PDF… this can take a moment.' : 'Syncing your knowledge base…');
        var token = localStorage.getItem('fa_token');
        var res = await fetch(API + '/api/kb/documents', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) { setStatus(''); return; }
        var docs = await res.json();
        renderDocs(docs);
        setStatus('');
        return currentDocs;
      }

      async function uploadFiles(files) {
        if (isUploading) return;
        if (!files || !files.length) return;
        setUploading(true);
        renderPending(files);

        try {
          var beforeCount = (currentDocs || []).length;
          var token = localStorage.getItem('fa_token');
          var fd = new FormData();
          for (var i = 0; i < files.length; i++) {
            fd.append('files', files[i], files[i].name);
          }
          var res = await fetch(API + '/api/kb/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: fd
          });
          var data = await res.json();
          if (!res.ok) throw new Error((data && data.detail) || 'Upload failed');
          // Poll until the doc shows up (indexing can take time)
          var start = Date.now();
          while (Date.now() - start < 15000) {
            var docs = await fetchDocs();
            if (docs && docs.length >= beforeCount + 1) break;
            await new Promise(function(r) { setTimeout(r, 900); });
          }
        } catch (err) {
          alert(err.message);
        } finally {
          setUploading(false);
        }
      }

      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (this.files.length) uploadFiles(this.files);
          this.value = '';
        });
      }

      if (filesList) {
        filesList.addEventListener('click', async function(e) {
          var btn = e.target.closest('.kb-file-remove');
          if (!btn) return;
          var item = btn.closest('.kb-file-item');
          var name = item.querySelector('.kb-file-name').textContent;
          var docId = item.getAttribute('data-doc-id');
          if (!docId) return;
          if (!confirm('Remove ' + name + '?')) return;

          var token = localStorage.getItem('fa_token');
          var res = await fetch(API + '/api/kb/documents/' + encodeURIComponent(docId), {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.ok) {
            currentDocs = (currentDocs || []).filter(function(d) { return d.id !== docId; });
            renderDocs(currentDocs, { force: true });
          }
        });
      }

      if (dropZone) {
        ['dragenter', 'dragover'].forEach(function(evt) {
          dropZone.addEventListener(evt, function(e) {
            e.preventDefault();
            dropZone.classList.add('is-dragover');
          });
        });
        ['dragleave', 'drop'].forEach(function(evt) {
          dropZone.addEventListener(evt, function(e) {
            e.preventDefault();
            dropZone.classList.remove('is-dragover');
          });
        });
        dropZone.addEventListener('drop', function(e) {
          if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
        });
      }

      // Render cached docs immediately to avoid flicker
      var cached = safeParse(localStorage.getItem(DOCS_CACHE_KEY) || '[]', []);
      if (Array.isArray(cached) && cached.length) renderDocs(cached, { force: true });
      fetchDocs();
    })();
  </script>
</body>
</html>
