<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lawyer Sessions – The Foundry Africa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="prefetch" href="ai.html">
  <link rel="prefetch" href="billing.html">
</head>
<body class="ai-page">

  <div class="ai-app">
    <button type="button" class="ai-sidebar-toggle" id="ai-sidebar-toggle" aria-label="Open menu" aria-expanded="false">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <aside class="ai-sidebar">
      <div class="ai-sidebar-inner">
        <nav class="ai-panel-nav">
          <a href="ai.html">AI</a>
          <a href="dashboard.html">Dashboard</a>
          <a href="knowledge-base.html">Knowledge Base</a>
          <a href="lawyer-sessions.html" class="ai-panel-nav-active">Lawyer Sessions</a>
          <a href="documents.html">Documents</a>
          <a href="billing.html">Billing</a>
        </nav>
      </div>
      <div class="ai-sidebar-account" id="sidebar-account">
        <button type="button" class="ai-account-btn" id="account-btn" aria-label="Account menu">
          <span class="ai-account-avatar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
          <span class="ai-account-name">My account</span>
        </button>
        <div class="ai-account-menu" id="account-menu">
          <a href="index.html" class="ai-account-menu-item">Home</a>
          <a href="#" class="ai-account-menu-item ai-account-logout" data-action="logout">Log out</a>
        </div>
      </div>
    </aside>
    <div class="ai-sidebar-overlay" id="ai-sidebar-overlay" aria-hidden="true"></div>

    <main class="ai-main">
      <div class="ls">
        <div class="ls-grid">
          <div class="ls-col-main">
            <section class="ls-book">
              <h2 class="ls-section-title">Book a session</h2>
              <form class="ls-form" id="ls-form">
                <div class="ls-form-row">
                  <div class="ls-field">
                    <label class="ls-label" for="ls-topic">Topic</label>
                    <select class="ls-input ls-select" id="ls-topic" required>
                      <option value="" disabled selected>Select a topic</option>
                      <option>Company registration</option>
                      <option>Contract review</option>
                      <option>Employment law</option>
                      <option>Compliance &amp; regulation</option>
                      <option>Intellectual property</option>
                      <option>Other</option>
                    </select>
                  </div>
                  <div class="ls-field">
                    <label class="ls-label" for="ls-date">Preferred date</label>
                    <input class="ls-input" type="date" id="ls-date" required>
                  </div>
                </div>
                <div class="ls-form-row">
                  <div class="ls-field">
                    <label class="ls-label" for="ls-time">Preferred time</label>
                    <select class="ls-input ls-select" id="ls-time" required>
                      <option value="" disabled selected>Select time</option>
                      <option>09:00 AM</option>
                      <option>10:00 AM</option>
                      <option>11:00 AM</option>
                      <option>12:00 PM</option>
                      <option>02:00 PM</option>
                      <option>03:00 PM</option>
                      <option>04:00 PM</option>
                    </select>
                  </div>
                  <div class="ls-field">
                    <label class="ls-label" for="ls-notes">Notes (optional)</label>
                    <textarea class="ls-input ls-textarea" id="ls-notes" rows="1" placeholder="Brief description..."></textarea>
                  </div>
                </div>
                <div class="ls-form-footer">
                  <button type="submit" class="ls-book-btn">Book session</button>
                </div>
              </form>
            </section>

            <section class="ls-upcoming">
              <h2 class="ls-section-title">Upcoming</h2>
              <div class="ls-session-list" id="ls-upcoming-list"></div>
              <div class="ls-empty-card" id="ls-upcoming-empty" style="display:none">No upcoming sessions yet.</div>
            </section>

            <section class="ls-past">
              <h2 class="ls-section-title">Past</h2>
              <div class="ls-session-list" id="ls-past-list"></div>
              <div class="ls-empty-card" id="ls-past-empty" style="display:none">No past sessions yet.</div>
            </section>
          </div>

          <div class="ls-col-side">
            <div class="ls-pricing-card">
              <div class="ls-pricing-top">
                <span class="ls-pricing-amount">KES 2,500</span>
                <span class="ls-pricing-per">per session</span>
              </div>
              <ul class="ls-pricing-features">
                <li>30-minute video call</li>
                <li>Kenyan-licensed lawyer</li>
                <li>Session recording available</li>
                <li>Follow-up notes via email</li>
              </ul>
              <div class="ls-pricing-pay">
                <img src="assets/mpesa.png" alt="M-Pesa" class="ls-pricing-mpesa">
                <span>Pay with M-Pesa</span>
              </div>
            </div>

            <div class="ls-stats-card">
              <div class="ls-stat">
                <span class="ls-stat-value" id="ls-stat-month">0</span>
                <span class="ls-stat-label">Sessions this month</span>
              </div>
              <div class="ls-stat">
                <span class="ls-stat-value" id="ls-stat-pending">0</span>
                <span class="ls-stat-label">Pending approvals</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="auth-guard.js"></script>
  <script src="app-shell.js" defer></script>
  <script>
    (function() {
      var API = 'http://localhost:8001';
      var accountBtn = document.getElementById('account-btn');
      var accountMenu = document.getElementById('account-menu');
      if (accountBtn && accountMenu) {
        accountBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          accountMenu.classList.toggle('is-open');
        });
        document.addEventListener('click', function() {
          accountMenu.classList.remove('is-open');
        });
      }

      var form = document.getElementById('ls-form');
      var submitBtn = form ? form.querySelector('button[type="submit"]') : null;
      var upcomingList = document.getElementById('ls-upcoming-list');
      var pastList = document.getElementById('ls-past-list');
      var upcomingEmpty = document.getElementById('ls-upcoming-empty');
      var pastEmpty = document.getElementById('ls-past-empty');
      var statMonth = document.getElementById('ls-stat-month');
      var statPending = document.getElementById('ls-stat-pending');

      function fmtDateParts(d) {
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return { day: String(d.getDate()), month: months[d.getMonth()] };
      }

      function fmtTime(d) {
        var h = d.getHours();
        var m = d.getMinutes();
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        if (h === 0) h = 12;
        var mm = m < 10 ? ('0' + m) : String(m);
        return h + ':' + mm + ' ' + ampm;
      }

      function statusClass(status) {
        if (status === 'confirmed') return 'ls-status-confirmed';
        if (status === 'completed') return 'ls-status-done';
        if (status === 'cancelled') return 'ls-status-done';
        return 'ls-status-pending';
      }

      function statusLabel(status) {
        if (status === 'confirmed') return 'Confirmed';
        if (status === 'completed') return 'Done';
        if (status === 'cancelled') return 'Cancelled';
        return 'Pending';
      }

      function renderList(listEl, emptyEl, sessions, isPast) {
        if (!listEl) return;
        listEl.innerHTML = '';
        if (!sessions.length) {
          if (emptyEl) emptyEl.style.display = '';
          return;
        }
        if (emptyEl) emptyEl.style.display = 'none';

        sessions.forEach(function(s) {
          var dt = new Date(s.scheduled_at);
          var parts = fmtDateParts(dt);
          var card = document.createElement('div');
          card.className = 'ls-session-card' + (isPast ? ' ls-session-past' : '');
          card.innerHTML =
            '<div class="ls-session-date">' +
              '<span class="ls-session-day">' + parts.day + '</span>' +
              '<span class="ls-session-month">' + parts.month + '</span>' +
            '</div>' +
            '<div class="ls-session-info">' +
              '<span class="ls-session-topic">' + s.topic + '</span>' +
              '<span class="ls-session-meta">' + fmtTime(dt) + ' · 30 min · Video call</span>' +
            '</div>' +
            '<span class="ls-session-status ' + statusClass(s.status) + '">' + statusLabel(s.status) + '</span>';
          listEl.appendChild(card);
        });
      }

      async function fetchSessions() {
        var token = localStorage.getItem('fa_token');
        var res = await fetch(API + '/api/sessions', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) return [];
        return await res.json();
      }

      function updateStats(all) {
        var now = new Date();
        var monthCount = 0;
        var pendingCount = 0;
        all.forEach(function(s) {
          var dt = new Date(s.scheduled_at);
          if (dt.getFullYear() === now.getFullYear() && dt.getMonth() === now.getMonth()) monthCount++;
          if (s.status === 'pending') pendingCount++;
        });
        if (statMonth) statMonth.textContent = String(monthCount);
        if (statPending) statPending.textContent = String(pendingCount);
      }

      async function refresh() {
        var all = await fetchSessions();
        updateStats(all);

        var now = new Date();
        var upcoming = [];
        var past = [];
        all.forEach(function(s) {
          var dt = new Date(s.scheduled_at);
          var isPast = dt < now || s.status === 'completed' || s.status === 'cancelled';
          (isPast ? past : upcoming).push(s);
        });

        // Sort ascending for upcoming, descending for past
        upcoming.sort(function(a, b) { return new Date(a.scheduled_at) - new Date(b.scheduled_at); });
        past.sort(function(a, b) { return new Date(b.scheduled_at) - new Date(a.scheduled_at); });

        renderList(upcomingList, upcomingEmpty, upcoming, false);
        renderList(pastList, pastEmpty, past, true);
      }

      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Booking…'; }

          var token = localStorage.getItem('fa_token');
          fetch(API + '/api/sessions/book', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              topic: document.getElementById('ls-topic').value,
              date: document.getElementById('ls-date').value,
              time: document.getElementById('ls-time').value,
              notes: document.getElementById('ls-notes').value
            })
          }).then(function(res) {
            return res.json().then(function(data) {
              if (!res.ok) throw new Error((data && data.detail) || 'Booking failed');
              return data;
            });
          }).then(function() {
            form.reset();
            alert('Session booked and is pending approval.');
            refresh();
          }).catch(function(err) {
            alert(err.message);
          }).finally(function() {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Book session'; }
          });
        });
      }

      refresh();
    })();
  </script>
</body>
</html>
